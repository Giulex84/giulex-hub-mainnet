<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Giulex Hub Mainnet</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  </head>

  <body>
    <h1>Giulex Hub Mainnet</h1>
    <button id="loginBtn">Login with Pi</button>

    <script>
      // ðŸ”’ Punto fermo: init sempre
      Pi.init({ version: "2.0" });

      const loginBtn = document.getElementById("loginBtn");

      loginBtn.addEventListener("click", async () => {
        try {
          // ðŸ”’ Punto fermo: auth SOLO su click
          const auth = await Pi.authenticate(
            ["username", "payments"],
            function onIncompletePaymentFound(payment) {
              console.log("Incomplete payment found", payment);
            }
          );

          console.log("Auth success:", auth);

          // âœ… U2A payment â€“ PI SDK (flow corretto)
          Pi.createPayment(
            {
              amount: 1,
              memo: "Mainnet U2A checklist step 10",
              metadata: { app: "giulex-hub-mainnet" }
            },
            {
              onReadyForServerApproval: async function (paymentId) {
                await fetch("https://logo-five-mu.vercel.app/api/pi", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    action: "approve",
                    paymentId: paymentId
                  })
                });
              },

              onReadyForServerCompletion: async function (paymentId, txid) {
                await fetch("https://logo-five-mu.vercel.app/api/pi", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    action: "complete",
                    paymentId: paymentId,
                    txid: txid
                  })
                });

                alert("U2A payment completed successfully");
              },

              onCancel: function (paymentId) {
                console.log("Payment cancelled", paymentId);
              },

              onError: function (error, payment) {
                console.error("Payment error", error, payment);
                alert("Payment error");
              }
            }
          );
        } catch (err) {
          console.error("Auth error:", err);
          alert("Authentication failed");
        }
      });
    </script>
  </body>
</html>
