<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Giulex Hub Mainnet</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  </head>

  <body>
    <h1>Giulex Hub Mainnet</h1>

    <button id="loginBtn">Login with Pi</button>

    <script>
      Pi.init({ version: "2.0" });

      const loginBtn = document.getElementById("loginBtn");

      loginBtn.addEventListener("click", async () => {
        try {
          const auth = await Pi.authenticate(
            ["username", "payments"],
            async function onIncompletePaymentFound(payment) {
              console.log("Incomplete payment found", payment);
            }
          );

          console.log("Auth success:", auth);

          // CREATE U2A payment via backend
          const createRes = await fetch("/api/pi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "create",
              uid: auth.user.uid,
              amount: 1,
              memo: "Mainnet U2A checklist step 10",
              metadata: { app: "giulex-hub-mainnet" }
            })
          });

          const payment = await createRes.json();
          console.log("Payment created:", payment);

          // Approve payment
          await fetch("/api/pi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "approve",
              paymentId: payment.identifier
            })
          });

          // Complete payment (U2A does not require txid)
          await fetch("/api/pi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "complete",
              paymentId: payment.identifier
            })
          });

          alert("U2A payment completed successfully");

        } catch (err) {
          console.error("Error:", err);
          alert("Error during Pi flow");
        }
      });
    </script>
  </body>
</html>
